# WorldCereal COP4GEOGLAM Scripts

This repository contains scripts for training and running crop type and cropland classification models using Presto embeddings and CatBoost classifiers, as well as for orchestrating large-scale production inference jobs.

## Script Overview

### 1. `scripts/finetune_presto.py`
**Purpose:**  
Fine-tunes a Presto model on country-specific crop type or land cover data.

**Main Steps:**
- Loads training/validation/test data from parquet files (see [`COUNTRY_PARQUET_FILES`](src/worldcereal_cop4geoglam/constants.py)).
- Selects a pretrained Presto model (see [`PRESTO_PRETRAINED_MODEL_PATH`](src/worldcereal_cop4geoglam/constants.py)).
- Sets up experiment parameters (augmentation, balancing, time-explicit labeling).
- Runs finetuning and saves the trained model and evaluation results.

**How to Run:**  
You can run with manual arguments or via command line.  
Example (manual args in script):
```sh
python scripts/finetune_presto.py \
    --experiment_tag new_val_ids \
    --timestep_freq month \
    --country moldova \
    --finetune_classes CROPTYPE_Moldova \
    --use_balancing \
    --val_samples_file /vitodata/worldcereal/data/COP4GEOGLAM/moldova/trainingdata/val_ids_moldova_qgis.csv
```
For running experiments, the manual arguments are mostly used example below 
```python
    manual_args = [
        "--experiment_tag",
        "new_val_ids", # change this to the name of your experiment
        "--timestep_freq",
        "month",
        "--country",
        "moldova", # country to processm also used for retrieving the correct class mapping files. currently supported moldova, kenya, mozambique
        "--augment", # if passed, it is automatically True
        "--finetune_classes",
        "CROPTYPE_Moldova", # name of the mapping to use. should match the one in class_mappings_<country>.json 
        "--use_balancing", # if passed, it is automatically True
        "--val_samples_file",
        "/vitodata/worldcereal/data/COP4GEOGLAM/moldova/trainingdata/val_ids_moldova_qgis.csv", # path to sample_ids used for testing. very useful to have a fix one to compare experiment results
    ]
```

---

### 2. `scripts/train_catboost.py`
**Purpose:**  
Trains a CatBoost classifier on embeddings generated by a fine-tuned Presto model.

**Main Steps:**
- Loads Presto model and data (embeddings or raw parquet files).
- Computes or loads embeddings for train/val/test splits.
- Maps classes and applies optional downstream class mapping.
- Trains CatBoost model with cross-validation and saves the model in CBM and ONNX formats.
- Evaluates and saves metrics and plots.

**How to Run:**  
You can use manual configuration (set `USE_MANUAL_CONFIG = True` in the script) or provide arguments via command line:
```sh
python scripts/train_catboost.py \
    --presto_model_path <path_to_finetuned_presto_model> \
    --data_dir <directory_with_parquet_or_embeddings> \
    --output_dir <output_directory> \
    --finetune_classes CROPTYPE_Moldova \
    --detector croptype \
    --country moldova \
    --balance False
```
The manual arguments are currently preferred to passing them via running from the terminal.
example of manual arguments for cropland: 
```python
    balance = ... # apply balancing to the classes 
    country = "moldova" # country (moldova, mozambique) 
    modelversion = "100-MDA" # model version. number-coutry abbreviation
    finetune_classes = "LANDCOVER10" # name of mapping to be used. should match the one reported in class_mappings_<country>.json
    detector = "cropland" # either cropland or croptype
    presto_model_name = "presto-prometheo-cop4geoglam-new_val_ids-month-LANDCOVER10-augment=False-balance=True-timeexplicit=False-run=202508271322" # just name of the model to be used (i.e. no need to provide extension nor whole path)
    downstream_classes = {
        "temporary_crops": "cropland",
        "temporary_grasses": "other",
        "permanent_crops": "cropland",
        "grasslands": "other",
        "wetlands": "other",
        "shrubland": "other",
        "trees": "other",
        "built_up": "other",
        "water": "other",
    } # dictionary mapping the LANDCOVER10 classes used to train presto to the binary classes 
``` 
Make sure to point to the right Presto model. the one used to generate the embeddings for training the cropland model should be Presto trained on `LANDCOVER10` classes.
The same manual arguments can be used for training the croptype model. In the latter case, there is no need of providing the `downstream_classes` as they correspond to the `finetune_classes`. 

---
### 3. Upload models in artifactory  

Once the presto and catboost models have been trained and a version is chosen, they need to be uploaded in artifactory at https://artifactory.vgt.vito.be/artifactory/auxdata-public/worldcereal/Copernicus4Geoglam/.
Copy the URLs to the models and report them in the `constants.py` script in the `PRODUCTION_MODELS_URLS` dictionary. 

---

### 4. `scripts/run_production.py`
**Purpose:**  
Submits large-scale inference jobs for crop type and cropland prediction using trained models.

**Main Steps:**
- Loads a grid of tiles for the target country (check [`generate_country_grid.py`](scripts/generate_country_grid.py) to generate the country grid)
- Sets up feature and classifier parameters using URLs from [`PRODUCTION_MODELS_URLS`](src/worldcereal_cop4geoglam/constants.py).
- Creates and manages inference jobs using OpenEO/CDSE backend.
- Handles job tracking, retries, and output organization.

**How to Run:**  
Edit the flexible parameters at the top of the script (country, output folder, production grid, dates, etc.), then run:
```sh
python scripts/run_production.py
```
The script will handle job creation and submission automatically.

---

## Setting Inputs

- **Country:**  
  Set via `--country` argument or variable in scripts. Supported countries are listed in [`COUNTRY_PARQUET_FILES`](src/worldcereal_cop4geoglam/constants.py).

- **Data Files:**  
  Parquet files for training/validation/testing must be present as specified in [`COUNTRY_PARQUET_FILES`](src/worldcereal_cop4geoglam/constants.py).

- **Pretrained Models:**  
  URLs/paths for pretrained Presto models are set in [`PRESTO_PRETRAINED_MODEL_PATH`](src/worldcereal_cop4geoglam/constants.py).

- **Model URLs for Production:**  
  URLs for production models are set in [`PRODUCTION_MODELS_URLS`](src/worldcereal_cop4geoglam/constants.py).

- **Other Parameters:**  
  Most scripts accept command-line arguments for experiment tags, balancing, augmentation, etc. See each script's argument parser for details.

---
### Data Location and Description

The main data folders used in this project are:

- **refdata/**  
  Contains reference datasets used for validation and benchmarking. (eg PSUs or sampled blocks from country grid to test on bigger areas)

- **auxdata/**  
  Contains auxiliary datasets such as masks, grids (eg country grids used for production), or supporting geospatial layers.

- **trainingdata/**  
  Contains training, validation, and test data (typically parquet files) for model development. (eg validation ids and inputs to train Presto)


Make sure to use the same folder structure for each country

---

## Additional Notes

- All outputs (trained models, metrics, logs) are saved in the specified output directories.
- For debugging or custom runs, you can modify the manual argument lists or variable assignments at the top of each script.
---
